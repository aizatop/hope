// Optimized version - production ready
const CONFIG = {
    SUPABASE: {
        URL: 'https://eybvtbskxktwurotecjl.supabase.co',
        KEY: 'sb_publishable_2fVufYc7abrhKrlZhy2ZJQ_nQqDR7f1'
    },
    MESSAGES: {
        AUTH_REQUIRED: '–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —á–∞—Ç—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É',
        LOGIN_SUCCESS: '–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!',
        REGISTER_SUCCESS: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.',
        LOGOUT_SUCCESS: '–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞'
    }
};

class AuthManager {
    constructor() {
        this.supabase = null;
        this.currentUser = null;
        this.init();
    }

    async init() {
        if (typeof window.supabase !== 'undefined') {
            this.supabase = window.supabase.createClient(CONFIG.SUPABASE.URL, CONFIG.SUPABASE.KEY);
            this.setupAuthListeners();
            await this.checkSession();
        }
    }

    setupAuthListeners() {
        this.supabase.auth.onAuthStateChange((event, session) => {
            this.currentUser = session?.user || null;
            if (event === 'SIGNED_IN' || event === 'SIGNED_OUT') {
                this.updateUI();
            }
        });
    }

    async checkSession() {
        try {
            const { data: { session } } = await this.supabase.auth.getSession();
            this.currentUser = session?.user || null;
            this.updateUI();
            return session;
        } catch (error) {
            console.error('Session check failed:', error);
            return null;
        }
    }

    async login(email, password) {
        try {
            const { data, error } = await this.supabase.auth.signInWithPassword({ email, password });
            if (error) throw error;
            return { success: true, data };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }

    async register(name, email, password) {
        try {
            const { data, error } = await this.supabase.auth.signUp({
                email,
                password,
                options: { data: { name } }
            });
            if (error) throw error;
            return { success: true, data };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }

    async logout() {
        try {
            const { error } = await this.supabase.auth.signOut();
            if (error) throw error;
            return { success: true };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }

    updateUI() {
        const authButtons = document.querySelector('.auth-buttons');
        if (!authButtons) return;

        if (this.currentUser) {
            const userName = this.currentUser.user_metadata?.name || 
                           this.currentUser.email?.split('@')[0] || 
                           '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            
            authButtons.innerHTML = `
                <span class="user-info">–ü—Ä–∏–≤–µ—Ç, ${userName}!</span>
                <button class="auth-btn chat-btn" onclick="chatManager.openPrivateChat()">üí¨ –ß–∞—Ç</button>
                <button class="auth-btn public-chat-btn" onclick="chatManager.openPublicChat()">üåç –ß–∞—Ç</button>
                <button class="auth-btn logout-btn" onclick="authManager.handleLogout()">–í—ã–π—Ç–∏</button>
            `;
        } else {
            authButtons.innerHTML = `
                <button class="auth-btn login-btn" onclick="modalManager.open('login')">–í–æ–π—Ç–∏</button>
                <button class="auth-btn register-btn" onclick="modalManager.open('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                <button class="auth-btn public-chat-btn" onclick="chatManager.openPublicChat()">üåç –ü—É–±–ª–∏—á–Ω—ã–π —á–∞—Ç</button>
            `;
        }
    }

    async handleLogout() {
        const result = await this.logout();
        if (result.success) {
            this.showNotification(CONFIG.MESSAGES.LOGOUT_SUCCESS);
            setTimeout(() => location.reload(), 500);
        } else {
            this.showNotification('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ' + result.error, 'error');
        }
    }

    showNotification(message, type = 'success') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 80px;
            right: 20px;
            background: ${type === 'success' ? 'var(--primary-rose)' : '#ff6b6b'};
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 3000;
            animation: slideIn 0.3s ease;
        `;
        
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);
    }
}

class ModalManager {
    constructor() {
        this.modals = {};
        this.setupEventListeners();
    }

    setupEventListeners() {
        // Close on outside click
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('auth-modal')) {
                this.close(e.target.id);
            }
        });

        // Close on ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                Object.keys(this.modals).forEach(modalId => this.close(modalId));
            }
        });
    }

    open(type) {
        const modalId = type === 'login' ? 'loginModal' : 'registerModal';
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
    }

    close(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    }

    switch(from, to) {
        this.close(from);
        this.open(to);
    }
}

class ChatManager {
    constructor() {
        this.authManager = null;
    }

    init(authManager) {
        this.authManager = authManager;
    }

    openPrivateChat() {
        if (!this.authManager.currentUser) {
            this.authManager.showNotification(CONFIG.MESSAGES.AUTH_REQUIRED, 'error');
            return;
        }
        window.open('chat.html', '_blank');
    }

    openPublicChat() {
        window.open('public-chat.html', '_blank');
    }
}

class UIManager {
    constructor() {
        this.setupAnimations();
        this.setupSmoothScroll();
    }

    setupAnimations() {
        // Intersection Observer for scroll animations
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, observerOptions);

        // Observe elements
        document.querySelectorAll('.country-card, .feature-item').forEach(el => {
            el.style.opacity = '0';
            el.style.transform = 'translateY(20px)';
            el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
            observer.observe(el);
        });
    }

    setupSmoothScroll() {
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', (e) => {
                e.preventDefault();
                const target = document.querySelector(anchor.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        });
    }
}

// Initialize everything
const authManager = new AuthManager();
const modalManager = new ModalManager();
const chatManager = new ChatManager();
const uiManager = new UIManager();

chatManager.init(authManager);

// Global functions for onclick handlers
window.openLoginModal = () => modalManager.open('login');
window.openRegisterModal = () => modalManager.open('register');
window.closeModal = (modalId) => modalManager.close(modalId);
window.switchToRegister = () => modalManager.switch('loginModal', 'registerModal');
window.switchToLogin = () => modalManager.switch('registerModal', 'loginModal');
window.openPublicChat = () => chatManager.openPublicChat();
window.openChat = () => chatManager.openPrivateChat();
window.scrollToCountries = () => {
    const countries = document.querySelector('.countries-grid');
    if (countries) countries.scrollIntoView({ behavior: 'smooth' });
};

// Form handlers
document.addEventListener('DOMContentLoaded', () => {
    // Login form
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            const result = await authManager.login(email, password);
            if (result.success) {
                authManager.showNotification(CONFIG.MESSAGES.LOGIN_SUCCESS);
                modalManager.close('loginModal');
                loginForm.reset();
            } else {
                authManager.showNotification('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + result.error, 'error');
            }
        });
    }

    // Register form
    const registerForm = document.getElementById('registerForm');
    if (registerForm) {
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            const result = await authManager.register(name, email, password);
            if (result.success) {
                authManager.showNotification(CONFIG.MESSAGES.REGISTER_SUCCESS);
                modalManager.close('registerModal');
                registerForm.reset();
            } else {
                authManager.showNotification('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + result.error, 'error');
            }
        });
    }
});

// Performance optimization
if ('requestIdleCallback' in window) {
    requestIdleCallback(() => {
        // Preload critical resources
        const preloadLinks = [
            { href: 'chat.html', as: 'document' },
            { href: 'public-chat.html', as: 'document' }
        ];
        
        preloadLinks.forEach(link => {
            const preload = document.createElement('link');
            preload.rel = 'prefetch';
            Object.assign(preload, link);
            document.head.appendChild(preload);
        });
    });
}
